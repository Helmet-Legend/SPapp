<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="version" content="1.9">
    <meta name="author" content="RESCUEAPP - LP ACADEMY">
    <meta name="copyright" content="¬© 2025 DECIOPS. Tous droits r√©serv√©s.">
    <meta name="description" content="Outil d'aide √† la d√©cision op√©rationnelle pour sapeurs-pompiers - Conforme GDO">
    
    <meta name="theme-color" content="#c41e3a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="DECIOPS">
    <meta name="mobile-web-app-capable" content="yes">
    
    <link rel="manifest" href="manifest.json">
    
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512.png">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    
    <title>DECIOPS v1.9</title>
    
    <link rel="stylesheet" href="css/styles.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Styles sp√©cifiques pour le g√©n√©rateur IA */
        .ia-container {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #c41e3a;
        }
        
        .ia-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            color: #c41e3a;
        }
        
        .ia-header i {
            font-size: 24px;
            margin-right: 10px;
        }
        
        .ia-header h2 {
            margin: 0;
            font-size: 1.4em;
            text-transform: uppercase;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 8px;
            margin-bottom: 15px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #eee;
        }

        .checkbox-item:hover {
            background: #e9ecef;
        }

        .checkbox-item input {
            margin-right: 10px;
        }

        .checkbox-item span {
            font-size: 0.85em;
        }

        .input-text, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
            font-family: inherit;
        }

        #btn-generer {
            width: 100%;
            padding: 15px;
            background: #c41e3a;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1.1em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: background 0.3s;
        }

        #btn-generer:hover {
            background: #a01830;
        }

        #btn-generer:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #resultat-ia {
            margin-top: 20px;
            padding: 15px;
            background: #f0f7ff;
            border-radius: 8px;
            border-left: 5px solid #007bff;
            display: none;
            white-space: pre-line;
            font-size: 0.95em;
            line-height: 1.5;
        }

        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <div class="logo-container">
                <i class="fas fa-fire-extinguisher"></i>
                <div class="logo-text">
                    <h1>DECIOPS</h1>
                    <span>Aide √† la D√©cision Op√©rationnelle</span>
                </div>
            </div>
            <div class="version-tag">v1.9</div>
        </header>

        <main>
            <section id="ia-manoeuvre" class="ia-container">
                <div class="ia-header">
                    <i class="fas fa-robot"></i>
                    <h2>G√©n√©rateur de Man≈ìuvre IA</h2>
                </div>

                <div class="form-group">
                    <label>Type de man≈ìuvre :</label>
                    <div class="checkbox-group">
                        <label class="checkbox-item"><input type="checkbox" name="type" value="Incendie Structure"><span>üî• Incendie</span></label>
                        <label class="checkbox-item"><input type="checkbox" name="type" value="Secours Routier"><span>üöó Secours Routier</span></label>
                        <label class="checkbox-item"><input type="checkbox" name="type" value="Lutte contre les feux de for√™t"><span>üå≤ Feu de For√™t</span></label>
                        <label class="checkbox-item"><input type="checkbox" name="type" value="Risque Technologique / NRBC"><span>‚ò¢Ô∏è NRBC</span></label>
                        <label class="checkbox-item"><input type="checkbox" name="type" value="Secours √† Personne (SAP)"><span>üöë SAP</span></label>
                        <label class="checkbox-item"><input type="checkbox" name="type" value="Op√©ration Diverses / √âpuisement"><span>üåä Op. Diverses</span></label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Engins engag√©s :</label>
                    <div class="checkbox-group">
                        <label class="checkbox-item"><input type="checkbox" name="vehicule" value="FPT / FPTSR"><span>üöí FPT/FPTSR</span></label>
                        <label class="checkbox-item"><input type="checkbox" name="vehicule" value="VSAV"><span>üöë VSAV</span></label>
                        <label class="checkbox-item"><input type="checkbox" name="vehicule" value="EPA / EPS"><span>ü™ú EPA</span></label>
                        <label class="checkbox-item"><input type="checkbox" name="vehicule" value="CCF"><span>üöí CCF</span></label>
                        <label class="checkbox-item"><input type="checkbox" name="vehicule" value="VLC / VLHR"><span>üöó VL</span></label>
                        <label class="checkbox-item"><input type="checkbox" name="vehicule" value="VSR / FSR"><span>üõ†Ô∏è VSR</span></label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Environnement :</label>
                    <div class="checkbox-group">
                        <label class="checkbox-item"><input type="checkbox" name="lieu" value="Urbain dense"><span>üèôÔ∏è Urbain</span></label>
                        <label class="checkbox-item"><input type="checkbox" name="lieu" value="Rural / Isol√©"><span>üè° Rural</span></label>
                        <label class="checkbox-item"><input type="checkbox" name="lieu" value="Zone Industrielle"><span>üè≠ Industriel</span></label>
                        <label class="checkbox-item"><input type="checkbox" name="lieu" value="Autoroute / VRU"><span>üõ£Ô∏è Autoroute</span></label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="nb-personnel">Effectif disponible (SP) :</label>
                    <input type="number" id="nb-personnel" value="8" min="2" max="30">
                </div>

                <div class="form-group">
                    <label for="consignes-particulieres">Consignes sp√©cifiques / sc√©nario particulier :</label>
                    <textarea id="consignes-particulieres" placeholder="Ex: Victime au 2√®me √©tage, propagation toiture, pr√©sence de bouteilles de gaz..."></textarea>
                </div>

                <button id="btn-generer" onclick="genererManoeuvre()">
                    <i class="fas fa-magic"></i> G√âN√âRER LE SC√âNARIO
                </button>

                <div id="resultat-ia">
                    <div id="scenario-contenu"></div>
                </div>
            </section>

            </main>
    </div>

    <script>
    async function genererManoeuvre() {
        const btn = document.getElementById('btn-generer');
        const resultatDiv = document.getElementById('resultat-ia');
        const contenuDiv = document.getElementById('scenario-contenu');

        // R√©cup√©ration des valeurs
        const getCheckedValues = (name) => {
            return Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(cb => cb.value);
        };

        const types = getCheckedValues('type');
        const vehicules = getCheckedValues('vehicule');
        const lieux = getCheckedValues('lieu');
        const nbSP = document.getElementById('nb-personnel').value;
        const consignes = document.getElementById('consignes-particulieres').value;

        if (types.length === 0) {
            alert('‚ö†Ô∏è Veuillez s√©lectionner au moins un type de man≈ìuvre');
            return;
        }

        // Pr√©paration du prompt pour l'IA
        const promptText = `G√©n√®re un sc√©nario d√©taill√© de man≈ìuvre sapeur-pompier. 
        TYPE: ${types.join(', ')}
        V√âHICULES: ${vehicules.join(', ')}
        LIEU: ${lieux.join(', ')}
        EFFECTIF: ${nbSP} sapeurs-pompiers
        CONSIGNES SP√âCIFIQUES: ${consignes}
        
        Format du r√©sultat attendu : 
        1. Situation initiale (S)
        2. Objectif de la man≈ìuvre (O)
        3. Id√©e de man≈ìuvre / Ordre Initial (I)
        4. Ex√©cution / Missions par bin√¥me (E)
        5. S√©curit√© (S)`;

        // UI Loading state
        btn.disabled = true;
        btn.innerHTML = '<div class="loading-spinner"></div> Analyse tactique en cours...';
        resultatDiv.style.display = 'none';

        try {
            // APPEL VERS L'API VERCEL (Secured)
            const response = await fetch('/api/gemini', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: promptText })
            });

            if (!response.ok) throw new Error('Erreur r√©seau ou serveur');

            const data = await response.json();
            
            if (data.error) throw new Error(data.error);

            // Affichage du r√©sultat
            contenuDiv.innerHTML = formatIAOutput(data.text);
            resultatDiv.style.display = 'block';
            resultatDiv.scrollIntoView({ behavior: 'smooth' });

        } catch (error) {
            console.error('Erreur:', error);
            alert('‚ùå Erreur de connexion au serveur tactique. V√©rifiez votre configuration Vercel.');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-magic"></i> G√âN√âRER LE SC√âNARIO';
        }
    }

    function formatIAOutput(text) {
        // Remplacement simple pour mettre en gras les titres et g√©rer les sauts de ligne
        return text
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\n/g, '<br>');
    }
    </script>

    <script src="js/data-loader.js"></script>
    <script src="js/modules/sal.js"></script>
    <script src="js/app.js"></script>
    
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('üöí DECIOPS: Service Worker enregistr√© avec succ√®s');
                    })
                    .catch(error => {
                        console.log('üöí DECIOPS: Erreur Service Worker:', error);
                    });
            });
        }
    </script>
</body>
</html>
